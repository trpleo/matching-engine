name: CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [develop]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-Dwarnings"

jobs:
  # Check branch naming convention
  branch-name:
    name: Branch Name Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.actor != 'dependabot[bot]'
    steps:
      - name: Check branch name
        run: |
          BRANCH="${{ github.head_ref }}"

          # Allow main and develop branches
          if [[ "$BRANCH" == "main" || "$BRANCH" == "develop" ]]; then
            echo "Branch '$BRANCH' is a protected branch, skipping naming convention check"
            exit 0
          fi

          # Allow release-please branches
          if [[ "$BRANCH" =~ ^release-please-- ]]; then
            echo "Branch '$BRANCH' is a release-please branch, skipping naming convention check"
            exit 0
          fi

          PATTERN="^(feature|bugfix|hotfix|release)\/[a-z0-9._-]+$"
          if [[ ! "$BRANCH" =~ $PATTERN ]]; then
            echo "::error::Branch name '$BRANCH' does not match pattern: $PATTERN"
            echo "Valid examples: feature/add-auth, bugfix/fix-login, hotfix/security-patch, release/1.0.0"
            exit 1
          fi
          echo "Branch name '$BRANCH' is valid"

  # Check commit messages follow Conventional Commits
  conventional-commits:
    name: Conventional Commits
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit messages
        run: |
          # Get commits in this PR
          COMMITS=$(git log --format="%s" origin/${{ github.base_ref }}..origin/${{ github.head_ref }})

          # Conventional Commits pattern
          PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .+"

          FAILED=0
          while IFS= read -r commit; do
            if [[ -n "$commit" && ! "$commit" =~ $PATTERN ]]; then
              echo "::error::Invalid commit message: '$commit'"
              echo "Expected format: type(scope)?: description"
              echo "Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
              FAILED=1
            fi
          done <<< "$COMMITS"

          if [[ $FAILED -eq 1 ]]; then
            exit 1
          fi
          echo "All commit messages follow Conventional Commits"

  # Format check
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --check

  # Lint with Clippy
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      # Note: avx512 feature excluded (requires nightly Rust)
      - run: cargo clippy --features "serde,async,logging" -- -D warnings

  # Build
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      # Note: avx512 feature excluded (requires nightly Rust)
      - run: cargo build --features "serde,async,logging"

  # Tests with coverage
  test:
    name: Test & Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: Swatinem/rust-cache@v2

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      # Note: avx512 feature excluded (requires nightly Rust)
      - name: Run tests with coverage
        run: cargo llvm-cov --features "serde,async,logging" --fail-under-lines 80 --lcov --output-path lcov.info

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false

  # Dependency checks with cargo-deny
  # Note: cargo-deny includes security advisory checks (see deny.toml [advisories] section)
  # This replaces the separate rustsec/audit-check which had reliability issues
  deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: EmbarkStudios/cargo-deny-action@v2
